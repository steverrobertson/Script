% Config params, overwrite any previous settings from the commandline
config ap_ssid 		MQTT_SERVICES
config ap_password	stevieray01
config ssid		GlenVista1CF0
config password		stevieray01
config ntp_server	1.de.pool.ntp.org
config mqtt_host	m14.cloudmqtt.com
config mqtt_port	19801
config mqtt_user	htzkfqlx
config mqtt_password	PLsADzYDYbdX
%config speed		160

% Now the initialization, this is done once after booting
on init
do
	% Device number
	% setvar $device_number = 1

	% @<num> vars are stored in flash and are persistent even after reboot 
	% setvar $run = @1 + 1
	% setvar @1 = $run
	% println "This is boot no "|$run

	% Status of the relay
	setvar $relay_status=0
	gpio_out 14 $relay_status
	% gpio_out 13 not ($relay_status)

	% Blink flag
	% setvar $blink=0

	% Command topic
	% setvar $command_topic="/martinshome/switch/" | $device_number | "/command"
	setvar $command_topic="WaterHeater/POWER"
	% setvar $this_data "TEST"

	% Voltage topic
	setvar $Voltage_topic="Voltage/VOLTS"

	% Status topic
	% setvar $status_topic="/martinshome/switch/" | $device_number | "/status"
	setvar $status_topic="WaterHeater/PWR"

	publish local $status_topic $relay_status retained

	% local subscriptions once in 'init'
	subscribe local $command_topic
	subscribe local $Voltage_topic

% Now the MQTT client init, this is done each time the client connects
on mqttconnect
do
	% remote subscriptions for each connection in 'mqttconnect'
	subscribe remote $command_topic

	publish remote $status_topic $relay_status retained

% Now the events, checked whenever something happens

% Is there a remote command?
on topic remote $command_topic
do
	println "Received remote command: " | $this_data

	% republish this locally - this does the action
	% publish local $command_topic $this_data


% Is there a local command?
on topic local $command_topic
do
	println "Received local command: " | $this_data

	if $this_data = "on" then
		setvar $relay_status = 1
		% setvar $blink = 0
		gpio_out 14 $relay_status
		% gpio_out 13 not ($relay_status)
	else
	    if $this_data = "off" then
		setvar $relay_status = 0
		% setvar $blink = 0
		gpio_out 14 $relay_status
		% gpio_out 13 not ($relay_status)
	    endif
	endif
	% if $this_data = "toggle" then
	%	setvar $relay_status = not ($relay_status)
	%	gpio_out 12 $relay_status
	%	gpio_out 13 not ($relay_status)
	% endif
	% if $this_data = "blink" then
	%	setvar $blink = 1
	%	settimer 1 500
	% endif

	publish local $status_topic $relay_status retained
	publish remote $status_topic $relay_status retained
	
on topic local $Voltage_topic
do
	println "Received local command: " | $this_data

	if $this_data > 54 then
		setvar $relay_status = 1
		% setvar $blink = 0
		gpio_out 14 $relay_status
		% gpio_out 13 not ($relay_status)
	else
	    if $this_data < 52.5 then
		setvar $relay_status = 0
		% setvar $blink = 0
		gpio_out 14 $relay_status
		% gpio_out 13 not ($relay_status)
	    endif
	endif

	publish remote $Voltage_topic $this_data

% The local pushbutton
% on gpio_interrupt 0 pullup
% do
	% println "New state GPIO 0: " | $this_gpio
	% if $this_gpio = 0 then
	%	setvar $blink = 0
	%	publish local $command_topic "toggle"
	% endif


% Blinking
%on timer 1
%do
%	if $blink = 1 then
%		publish local $command_topic "toggle"
%		settimer 1 500
%	endif
